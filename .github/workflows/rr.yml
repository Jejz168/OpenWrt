#===============================================
# Description: X86_64
# Lisence: MIT
# Byï¼šJejz
#===============================================

name: Build_x86_64

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      checkupdates54:
        description: 'Checkupdates54 connection to Actions'
        required: false
        default: 'false'
      checkupdates510:
        description: 'Checkupdates510 connection to Actions'
        required: false
        default: 'false'
      checkupdates515:
        description: 'Checkupdates515 connection to Actions'
        required: false
        default: 'false'
      checkupdates61:
        description: 'Checkupdates61 connection to Actions'
        required: false
        default: 'false'
      checkupdates66:
        description: 'Checkupdates66 connection to Actions'
        required: false
        default: 'false'
      ssh54:
        description: 'SSH54 connection to Actions'
        required: false
        default: 'false'
      ssh510:
        description: 'SSH510 connection to Actions'
        required: false
        default: 'false'
      ssh515:
        description: 'SSH515 connection to Actions'
        required: false
        default: 'false'
      ssh61:
        description: 'SSH61 connection to Actions'
        required: false
        default: 'false'
      ssh66:
        description: 'SSH66 connection to Actions'
        required: false
        default: 'false'
  schedule:
    - cron: 2 19 * * *

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds_config/lean.feeds.conf.default
  CONFIG_FILE: config/leanlede_config/x86.config
  CONFIGS: config/leanlede_config
  DIY_P1_SH: diy_script/lean_diy/x86/diy-part1.sh
  DIY_P2_SH: diy_script/lean_diy/x86/diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_CONFIG: true
  UPLOAD_FIRMWARE: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  FILE_NAME: x86_64
  PRODUCT_NAME: x86_64

jobs:
  Build_x86_64_54:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check server configuration
      run: |
        echo "è­¦å‘Šâš "
        echo "è‹¥åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½ä¸è¶³ï¼ŒåŠ¡å¿…åŠæ—¶å–æ¶ˆï¼Œé‡æ–°è¿è¡Œï¼"
        echo "å·²çŸ¥ç¼–è¯‘æˆåŠŸCPUå‹å·ï¼š8370C,8272CL"
        echo "å·²çŸ¥æ€§èƒ½ä¸è¶³CPUå‹å·ï¼š8171M"
        echo -e "-------------- ------------CPUä¿¡æ¯------------------------------------------\n"
        echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
        echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo "-------------------------------å†…å­˜ä¿¡æ¯-------------------------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
        sudo lshw -short -C memory | grep GiB
        echo -e "\n"
        echo "-----------------------------ç¡¬ç›˜ä¿¡æ¯---------------------------------------------"
        echo -e  "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
        echo "ç¡¬ç›˜è¯¦æƒ…ï¼š"
        echo " ç³»ç»Ÿç©ºé—´       ç±»å‹   æ€»æ•°  å·²ç”¨  å¯ç”¨  ä½¿ç”¨ç‡"
        df -Th

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E swapoff -a
        sudo -E rm -f /swapfile
        sudo -E docker image prune -a -f
        sudo -E snap set system refresh.retain=2
        sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android
        sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* llvm* firefox google* dotnet* powershell* openjdk* mysql* php* mongodb* dotnet* moby* snap* aspnetcore*
        [ -n "$AGENT_TOOLSDIRECTORY" ] && sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo -E apt-get update
        sudo -E apt-get -y install $(curl -fsSL https://is.gd/depends_ubuntu_2204)
        sudo -E apt-get -y install libfuse-dev clang
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
        sudo rm -rf ~/{.cargo,.dotnet,.rustup}
        sudo timedatectl set-timezone "$TZ"
        df -Th

    - name: Create release
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success'
      with:
        name: ${{ env.DATE }} ã€Œ ${{ env.FILE_NAME }}_${{ env.KERNEL }} ã€å›ºä»¶
        allowUpdates: true
        tag: ${{ env.TAG }}_${{ env.KERNEL }}
        token: ${{ secrets.GH_TOKEN }}
        body: |
          - â­ï¸æ­¤ä¸º ${{ env.FILE_NAME }}_${{ env.KERNEL }} å›ºä»¶
          - ğŸ”´é»˜è®¤IPï¼š192.168.8.3 é»˜è®¤å¯†ç ï¼šæ— å¯†ç 
          - å½“å‰ä½¿ç”¨ç‰ˆæœ¬:ã€ç¼–è¯‘å‰çš„æœ€åä¸€æ¬¡[â¦ä¸»æºç ](https://github.com/coolsnowwolf/lede)æ›´æ–°è®°å½•ã€‘
          - â˜… æ„Ÿè°¢æºç ä½œè€…æ— ç§åˆ†äº«ï¼
          - ğŸˆğŸˆğŸˆ æ›´æ–°ä¿¡æ¯ ğŸˆğŸˆğŸˆ
          - ä½œè€…: ${{ env.author }}
          - æ—¶é—´: ${{ env.date }}
          - å†…å®¹: ${{ env.commit }}
          - hash: ${{ env.hash }}
        artifacts: ${{ env.FIRMWARE }}/*

    - name: Completion time 
      run: |
        echo "END=$(date "+%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        end=$(date +%s)
        seconds=$(( end - start ))
        hour=$(( $seconds/3600 ))
        min=$(( ($seconds-${hour}*3600)/60 ))
        sec=$(( $seconds-${hour}*3600-${min}*60 ))
        HMS=`echo ${hour}:${min}:${sec}`
        echo "time=$HMS" >> $GITHUB_ENV

    - name: Telegram notification upload success
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          â™¨ï¸ ğŸ³${{ env.FILE_NAME }}_${{ env.KERNEL }}ç¼–è¯‘å®Œæˆ
          å¼€å§‹æ—¶é—´ï¼š${{ env.DATE }}
          å®Œæˆæ—¶é—´ï¼š${{ env.END }}
          ç¼–è¯‘è€—æ—¶ï¼š${{ env.time }}
          ğŸˆğŸˆğŸˆ æ›´æ–°ä¿¡æ¯ ğŸˆğŸˆğŸˆ
          ä½œè€…: ${{ env.author }}
          æ—¶é—´: ${{ env.date }}
          å†…å®¹: ${{ env.commit }}
          hash: ${{ env.hash }}
          âœª âœ£ âœ¤ âœ¥ âœ¦ â‰ â¦ â§ âƒ â‚ â â€
          ğŸ“: https://github.com/Jejz168/OpenWrt/releases/tag/${{ env.TAG }}_${{ env.KERNEL }}

    - name: Push notification upload success
      uses: xhnmt/pushplus-action@v1.0.0
      with:
        token: ${{ secrets.PUSH_PLUS_TOKEN }}
        title: "${{ env.FILE_NAME }}_${{ env.KERNEL }}ç¼–è¯‘å®Œæˆ"
        content: |
          â™¨ï¸ ğŸ³${{ env.FILE_NAME }}_${{ env.KERNEL }}ç¼–è¯‘å®Œæˆ
          å¼€å§‹æ—¶é—´ï¼š${{ env.DATE }}
          å®Œæˆæ—¶é—´ï¼š${{ env.END }}
          ç¼–è¯‘è€—æ—¶ï¼š${{ env.time }}
          ğŸˆğŸˆğŸˆ æ›´æ–°ä¿¡æ¯ ğŸˆğŸˆğŸˆ
          ä½œè€…: ${{ env.author }}
          æ—¶é—´: ${{ env.date }}
          å†…å®¹: ${{ env.commit }}
          hash: ${{ env.hash }}
          âœª âœ£ âœ¤ âœ¥ âœ¦ â‰ â¦ â§ âƒ â‚ â â€
          ğŸ“: https://github.com/Jejz168/OpenWrt/releases/tag/${{ env.TAG }}_${{ env.KERNEL }}
